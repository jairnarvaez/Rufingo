{% extends 'flashcards/base.html' %}

{% block title %}Sesi√≥n de Repaso - Rufingo{% endblock %}

{% block extra_css %}
<style>
    .session-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .session-title {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #D52B1E, #FFD700);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }
    
    .flashcard {
        perspective: 1500px;
        min-height: 450px;
        margin: 0px auto;
        max-width: 750px;
    }
    
    .flashcard-inner {
        position: relative;
        width: 100%;
        min-height: 450px;
        transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1);
        transform-style: preserve-3d;
    }
    
    .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }
    
    .flashcard-front, .flashcard-back {
        position: absolute;
        width: 100%;
        min-height: 450px;
        backface-visibility: hidden;
        border-radius: 20px;
        padding: 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        border: 0px solid #D52B1E;
    }
    
    .flashcard-front {
        background: linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%);
        color: #2d3748;
    }
    
    .flashcard-back {
        background: linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%);
        color: #2d3748;
        transform: rotateY(180deg);
    }
    
    .card-label {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 2px;
        margin-bottom: 25px;
        padding: 8px 20px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }
    
    .flashcard-front .card-label {
        background: linear-gradient(135deg, #D52B1E, #B71C1C);
        color: white;
    }
    
    .flashcard-back .card-label {
        background: linear-gradient(135deg, #D52B1E, #B71C1C);

        color: white;
    }
    
    .card-content {
        font-size: 28px;
        line-height: 1.6;
        word-wrap: break-word;
        font-weight: 700;
        color: #2d3748;
    }
    
    .timer {
        position: fixed;
        top: 100px;
        right: 20px;
        background: linear-gradient(135deg, #FFD700, #FFA000);
        padding: 18px 28px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        font-size: 26px;
        font-weight: 800;
        color: white;
        z-index: 1000;
        border: 0px solid white;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .botones-calificacion {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 35px;
        width: 100%;
        max-width: 550px;
    }
    
    .btn-calificacion {
        padding: 18px 15px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .btn-calificacion:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    
    .btn-calificacion:active {
        transform: translateY(-2px) scale(1.02);
    }
    
    .btn-cal-5 { 
        background: linear-gradient(135deg, #00C853, #00E676);
    }
    .btn-cal-4 { 
        background: linear-gradient(135deg, #76FF03, #64DD17);
    }
    .btn-cal-3 { 
        background: linear-gradient(135deg, #FFD700, #FFA000);
    }
    .btn-cal-2 { 
        background: linear-gradient(135deg, #FF6D00, #F57C00);
    }
    .btn-cal-1 { 
        background: linear-gradient(135deg, #D32F2F, #C62828);
    }
    .btn-cal-0 { 
        background: linear-gradient(135deg, #616161, #424242);
    }
    
    .flip-btn {
        margin-top: 35px;
        padding: 18px 45px;
        background: linear-gradient(135deg, #D52B1E, #B71C1C);
        border: 3px solid #B71C1C;
        color: white;
        border-radius: 15px;
        font-size: 20px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(213, 43, 30, 0.3);
    }
    
    .flip-btn:hover {
        background: linear-gradient(135deg, #B71C1C, #D52B1E);
        transform: scale(1.08);
        box-shadow: 0 6px 20px rgba(213, 43, 30, 0.5);
    }
    
    .info-tarjeta {
        margin-top: 25px;
        padding: 18px 25px;
        background: white;
        border-radius: 12px;
        font-size: 15px;
        display: flex;
        gap: 25px;
        justify-content: center;
        border: 2px solid #E0E0E0;
        color: #2d3748;
        font-weight: 600;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .loading {
        text-align: center;
        padding: 60px;
        font-size: 24px;
        color: #D52B1E;
        font-weight: 700;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(213, 43, 30, 0.2);
        border-top-color: #D52B1E;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .question-prompt {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 12px;
        border: 2px solid #E0E0E0;
        color: #2d3748;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .flashcard {
            max-width: 100%;
            margin: 20px 0;
        }
        
        .flashcard-front, .flashcard-back {
            padding: 30px 20px;
            min-height: 350px;
        }
        
        .card-content {
            font-size: 22px;
        }
        
        .botones-calificacion {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .timer {
            top: 650px;
            right: 150px;
            padding: 12px 20px;
            font-size: 20px;
        }
        
        .session-title {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="timer" id="timer">‚è±Ô∏è 0.0s</div>

<div class="flashcard" id="flashcard">
    <div class="flashcard-inner">
        <div class="flashcard-front">
            <div>
                <div class="card-label"> PREGUNTA</div>
                <div class="card-content">{{ card.frente }}</div>
                <button class="flip-btn" onclick="voltearTarjeta()"> Ver Respuesta</button>
                <div class="info-tarjeta">
                    <div class="info-item">
                        <span>üìä</span>
                        <span><strong>{{ card.get_estado_display }}</strong></span>
                    </div>
                    <div class="info-item">
                        <span>üéØ</span>
                        <span><strong>Fase {{ card.fase }}</strong></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flashcard-back">
            <div>
                <div class="card-label"> RESPUESTA</div>
                <div class="card-content">{{ card.reverso }}</div>
                
                <div class="question-prompt">
                    ¬øQu√© tan bien lo recordaste?
                </div>
                
                <div class="botones-calificacion">
                    <button class="btn-calificacion btn-cal-5" onclick="calificar(5)">
                        üòÑ<br><strong>Perfecto</strong>
                    </button>
                    <button class="btn-calificacion btn-cal-4" onclick="calificar(4)">
                        üôÇ<br><strong>Bien</strong>
                    </button>
                    <button class="btn-calificacion btn-cal-3" onclick="calificar(3)">
                        üòê<br><strong>Con Esfuerzo</strong>
                    </button>
                    <button class="btn-calificacion btn-cal-2" onclick="calificar(2)">
                        üòï<br><strong>Dif√≠cil</strong>
                    </button>
                    <button class="btn-calificacion btn-cal-1" onclick="calificar(1)">
                        üòû<br><strong>Mal</strong>
                    </button>
                    <button class="btn-calificacion btn-cal-0" onclick="calificar(0)">
                        üò¢<br><strong>No record√©</strong>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <div>‚è≥ Procesando tu respuesta...</div>
</div>

<script>
    const cardId = {{ card.id }};
    let startTime = performance.now();
    let timerInterval;
    let isFlipped = false;
    let tiempoRespuesta = 0.0;
    
    // Iniciar temporizador
    function iniciarTimer() {
        timerInterval = setInterval(() => {
            const elapsed = (performance.now() - startTime) / 1000;
            document.getElementById('timer').textContent = `‚è±Ô∏è ${elapsed.toFixed(1)}s`;
        }, 100);
    }
    
    // Voltear tarjeta
    function voltearTarjeta() {
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.add('flipped');
        isFlipped = true;
        
        clearInterval(timerInterval);
        tiempoRespuesta = (performance.now() - startTime) / 1000;
    }
    
    // Calificar respuesta
    async function calificar(calificacion) {
        if (!isFlipped) {
            // Crear alerta personalizada
            const alerta = document.createElement('div');
            alerta.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FF6D00, #F57C00);
                color: white;
                padding: 2rem 3rem;
                border-radius: 20px;
                font-size: 1.3rem;
                font-weight: 700;
                text-align: center;
                box-shadow: 0 10px 30px rgba(255, 109, 0, 0.4);
                z-index: 10000;
                animation: popIn 0.3s ease;
                border: 3px solid white;
            `;
            alerta.textContent = '‚ö†Ô∏è Primero debes ver la respuesta';
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.style.animation = 'popOut 0.3s ease';
                setTimeout(() => alerta.remove(), 300);
            }, 2000);
            return;
        }
        
        // Mostrar loading
        document.getElementById('flashcard').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        
        try {
            const response = await fetch('{% url "procesar_respuesta" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    card_id: cardId,
                    calificacion_base: calificacion,
                    tiempo_respuesta: tiempoRespuesta
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (data.siguiente_tarjeta) {
                    // Recargar p√°gina para siguiente tarjeta
                    window.location.href = '{% url "sesion_repaso" %}';
                } else {
                    // No hay m√°s tarjetas
                    window.location.href = '{% url "resultado_repaso" %}';
                }
            } else {
                alert('‚ùå Error: ' + data.error);
                location.reload();
            }
        } catch (error) {
            alert('‚ùå Error al procesar la respuesta: ' + error);
            location.reload();
        }
    }
    
    // Iniciar al cargar
    window.addEventListener('load', iniciarTimer);
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ' && !isFlipped) {
            e.preventDefault();
            voltearTarjeta();
        } else if (isFlipped && e.key >= '0' && e.key <= '5') {
            calificar(parseInt(e.key));
        }
    });
    

</script>
{% endblock %}
